---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  warning = FALSE, 
  error = FALSE, 
  message = FALSE,
  cache = TRUE
)
```

# tuik

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![R build status](https://github.com/emraher/tuik/workflows/R-CMD-check/badge.svg)](https://github.com/emraher/tuik/actions)
[![DOI](https://zenodo.org/badge/313863336.svg)](https://zenodo.org/badge/latestdoi/313863336)
<!-- badges: end -->

The goal of `tuik` is to extract data file and database URLs from [TUIK](https://data.tuik.gov.tr/) webpage. Package can also download data from [Geographical Statistics Portal](https://cip.tuik.gov.tr/).

## Installation

You can install the development version from [GitHub](https://github.com/emraher/tuik) with:

``` r
# install.packages("devtools")
devtools::install_github("emraher/tuik")
```

## Example

```{r}
library(tidyverse)
library(tuik)

(st <- statistical_themes())

# stab <- statistical_tables("aaa")
#> Error in check_theme_id(theme) : 
#>  You should select a valid theme ID!

# stab <- statistical_tables(c(123, 143))
#> Error in check_theme_id(theme) : You can select only one theme!

(stab <- statistical_tables("110"))

# sdb <- statistical_databases("aaa")
#> Error in check_theme_id(theme) : 
#>  You should select a valid theme ID!

# sdb <- statistical_databases(c(123, 143))
#> Error in check_theme_id(theme) : You can select only one theme!

(sdb <- statistical_databases(110))

# -------------------------------------------------------------------------- ###
# Saving Data Files----
# -------------------------------------------------------------------------- ###
# Read xls files directly into R
# NOTE: TUIK xls files are messy!!!
(dt <- tibble::as_tibble(gdata::read.xls(stab$datafile_url[1])))

# Download file from URL
filename <- paste0(janitor::make_clean_names(stab$data_name[1]),
                   janitor::make_clean_names(stab$data_date[1]))

download.file(stab$datafile_url[1],
              destfile = paste0("~/Downloads/", filename, ".xls"),
              mode = "wb")


# -------------------------------------------------------------------------- ###
# All DB Links----
# -------------------------------------------------------------------------- ###
all_dbs <- purrr::map_df(.x = st$theme_id, .f = ~statistical_databases(.x))

all_dbs %>%
  dplyr::count(theme_name, name = "database_count")

# -------------------------------------------------------------------------- ###
# Download Geo Data----
# -------------------------------------------------------------------------- ###
# Download Variable Names and Codes
(dt <- geo_data())

# dt <- geo_data(5)
#> Error in geo_data(5) : There's no IBBS at this level!

# Download data for a given level and variable
(dt <- geo_data(2, "SNM-GK160951-O33303"))

# (dt <- geo_data(4, "TFE-GK105747-O23001"))
#> Error in value[[3L]](cond) : 
#>  This data (TFE-GK105747-O23001) is not available at this NUTS level (level = 4)!!!

# -------------------------------------------------------------------------- ###
# Download Geo Map----
# -------------------------------------------------------------------------- ###
(dt_sf <- geo_map(9))

(dt_sf <- geo_map(3))
```



## Map Examples

### NUTS-2
```{r}
chicken <- geo_data(2, "HYV-GK1696800-O32507") %>% 
  dplyr::filter(date %in% c("2015", "2019"))

geo_map(2) %>% 
  left_join(chicken) %>% 
  ggplot() +
  geom_sf(aes(fill = yumurta_tavugu_sayisi_adet), color = "white") +
  coord_sf(datum = NA) + 
  rcartocolor::scale_fill_carto_c(palette = "Safe") +
  hrbrthemes::theme_ipsum_rc() +
  theme(legend.position = "bottom", legend.key.width = unit(3, "cm")) +
  labs(fill = "",
       title = "Yumurta Tavuğu (Adet)",
       caption = "Kaynak: TÜİK") +
  facet_wrap(~date, ncol = 2)
```


### NUTS-3
```{r}
house <- geo_data(3, "INS-GK055-O006") %>% 
  filter(date == 2019) %>% 
  mutate(code = as.numeric(code))

# Let's select different colors
pal <- wesanderson::wes_palette("BottleRocket2", 50, type = "continuous")

geo_map(3) %>% 
  left_join(house) %>% 
  ggplot() +
  geom_sf(aes(fill = konut_satis_sayilari_toplam)) +
  coord_sf(datum = NA) + 
  scale_fill_gradientn(colours = pal) + 
  hrbrthemes::theme_ipsum_rc() +
  theme(legend.position = "bottom", 
        legend.key.width = unit(3, "cm"),
        plot.title = element_text(hjust = 0.5)) +
  labs(fill = "",
       title = "2019 Yılında Konut Satış Sayıları",
       caption = "Kaynak: TÜİK")
```


### LAU-1

```{r}

pal <- c("#f7f7f7", "#d9d9d9", "#bdbdbd", "#969696", "#737373", "#525252", "#252525")

geo_data(4, "ULE-GK160887-O29502") %>% 
  filter(date == 2019) %>% 
  mutate(code = as.numeric(code)) %>% 
  left_join(geo_map(level = 4), .) %>% 
  ggplot() +
  geom_sf(aes(fill = okuma_yazma_bilmeyen_sayisi), lwd = 0.1) +
  coord_sf(datum = NA) + 
  scale_fill_gradientn(colours = pal) +
  theme_bw() +
  theme(legend.position = "bottom", 
        legend.key.width = unit(3, "cm"),
        plot.title = element_text(hjust = 0.5)) +
  labs(fill = "",
       title = "2019 Yılında Okuma Yazma Bilmeyen Sayısı",
       caption = "Kaynak: TÜİK")
```

```{r}
geo_data(4, "ADNKS-GK137473-O29001") %>% 
  filter(date == 2019) %>% 
  mutate(code = as.numeric(code)) %>% 
  left_join(geo_map(level = 4), .) %>% 
  filter(iladi == "ANKARA") %>% 
  ggplot() +
  geom_sf(aes(fill = toplam_nufus_kisi)) +
  scale_fill_viridis_c(option = "E") +
  labs(fill = "Population in 2019") +
  hrbrthemes::theme_ipsum_rc()
```

